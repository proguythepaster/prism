<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>prism</title>
<style>
:root {
    --bg: #0b0d10;
    --panel: #14161c;
    --panel-soft: #1b1e26;
    --accent: #f5c518;
    --text: #ffffff;
    --muted: #9aa0aa;
}

* { box-sizing: border-box; }

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: linear-gradient(180deg, #0b0d10 0%, #050608 100%);
    color: var(--text);
    margin: 0;
}

/* ===== TOP BAR ===== */
.top-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 28px;
    background: rgba(11,13,16,0.85);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

h1 {
    margin: 0;
    font-size: 26px;
    font-weight: 800;
    cursor: pointer;
    letter-spacing: 0.3px;
}

.search-box {
    display: flex;
    background: var(--panel);
    border-radius: 999px;
    overflow: hidden;
}

input {
    width: 260px;
    padding: 10px 14px;
    background: transparent;
    color: var(--text);
    border: none;
    outline: none;
}

button {
    padding: 10px 16px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    background: var(--accent);
    color: #000;
}

/* ===== RESULTS GRID ===== */
.results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 18px;
    padding: 28px;
}

.card {
    background: linear-gradient(180deg, var(--panel-soft), var(--panel));
    border-radius: 14px;
    padding: 12px;
    transition: transform .2s ease, box-shadow .2s ease;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.card img {
    width: 100%;
    border-radius: 10px;
    aspect-ratio: 2/3;
    object-fit: cover;
}

.card h3 {
    font-size: 15px;
    margin: 10px 0 6px;
    line-height: 1.3;
}

.play-button {
    width: 100%;
    margin-top: 6px;
    border-radius: 999px;
}

/* ===== VIDEO / EPISODES VIEW ===== */
#video-container {
    position: fixed;
    top: 76px;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, #07080b, #000);
    display: none;
    z-index: 50;
    padding: 28px;
    overflow-y: auto;
}

#video-container h2 {
    margin-top: 0;
    font-size: 26px;
}

#video-container iframe {
    width: 100%;
    height: 70vh;
    border-radius: 14px;
    margin-bottom: 24px;
}

#video-container button {
    background: var(--panel-soft);
    color: var(--text);
    border-radius: 999px;
    padding: 8px 14px;
    margin: 6px 6px 0 0;
}

#video-container button:hover {
    background: var(--accent);
    color: #000;
}

body.video-playing {
    overflow: hidden;
}

/* ===== CONTINUE WATCHING ===== */
#continue-row {
    display: none;
    padding: 20px 28px;
}

#continue-card .card {
    max-width: 200px;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    overflow: hidden;
}

#continue-card img {
    width: 100%;
    border-radius: 10px;
    object-fit: cover;
}

#continue-card .info {
    padding: 6px 8px;
    text-align: center;
}

#next-episode-btn {
    position: absolute;
    bottom: 28px;
    right: 28px;
    display: none;
    z-index: 60;
    padding: 10px 16px;
    font-weight: 700;
    border-radius: 999px;
    cursor: pointer;
    background: var(--accent);
    color: #000;
}
</style>
</head>
<body>

<div class="top-bar">
    <h1 id="logo">prismLOL &lt;3</h1>
    <div class="search-box">
        <input id="query" placeholder="Search movie or TV show..." />
        <button onclick="search()">Search</button>
    </div>
</div>

<div id="continue-row">
    <h2>Continue Watching</h2>
    <div id="continue-card"></div>
</div>

<div id="video-container"></div>
<button id="next-episode-btn">Next Episode →</button>
<div class="results" id="results"></div>

<script>
const API_KEY = "65277ee3";
const TMDB_API_KEY = "a7856adff8aa06bd9d9fa0b21d0ea593";

/* ===== COOKIE HELPERS ===== */
function setCookie(name, value, days = 30) {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}
function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
}
function deleteCookie(name) {
    document.cookie = `${name}=; Max-Age=0; path=/`;
}

/* ===== CONTINUE WATCHING ===== */
function loadContinueWatching() {
    const data = getCookie("continueWatching");
    const row = document.getElementById("continue-row");
    const card = document.getElementById("continue-card");

    if (!data) {
        row.style.display = "none";
        card.innerHTML = "";
        return;
    }

    const episode = JSON.parse(data);

    // Fetch TV show details from TMDB to get show name and poster
    fetch(`https://api.themoviedb.org/3/tv/${episode.tvId}?api_key=${TMDB_API_KEY}`)
        .then(res => res.json())
        .then(info => {
            const poster = info.poster_path 
                ? `https://image.tmdb.org/t/p/w500${info.poster_path}` 
                : "";
            const showName = info.name || "Unknown Show";

            card.innerHTML = `
                <div class="card">
                    <img src="${poster}" alt="${showName}">
                    <div class="info">
                        <h3>${showName}</h3>
                        <p>Season ${episode.season} · Episode ${episode.episode}</p>
                        <button class="play-button">Continue</button>
                    </div>
                </div>
            `;

            card.querySelector("button").addEventListener("click", () => {
                playVideo(`https://vidlink.pro/tv/${episode.tvId}/${episode.season}/${episode.episode}`, episode);
            });

            row.style.display = "block";
        });
}


/* ===== LOGO CLICK RESET ===== */
document.getElementById("logo").addEventListener("click", () => {
    document.getElementById("query").value = "";
    document.getElementById("results").innerHTML = "";

    const videoContainer = document.getElementById("video-container");
    videoContainer.style.display = "none";
    videoContainer.innerHTML = "";

    document.body.classList.remove("video-playing");
    history.pushState({}, "");

    loadContinueWatching();
});

/* ===== HISTORY / BACK BUTTON ===== */
window.addEventListener("popstate", () => {
    const videoContainer = document.getElementById("video-container");
    videoContainer.style.display = "none";
    videoContainer.innerHTML = "";
    document.body.classList.remove("video-playing");
});

/* ===== SEARCH ===== */
async function search() {
    const q = document.getElementById("query").value.trim();
    if (!q) return;

    const res = await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&s=${encodeURIComponent(q)}`);
    const data = await res.json();

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (data.Response === "False") {
        resultsDiv.innerHTML = "<p style='padding:20px'>No results found.</p>";
        return;
    }

    data.Search.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <img src="${item.Poster !== "N/A" ? item.Poster : ""}">
            <h3>${item.Title} (${item.Type})</h3>
            <button class="play-button">Play</button>
        `;

        card.querySelector(".play-button").addEventListener("click", async () => {
            if (item.Type === "movie") {
                const tmdbRes = await fetch(
                    `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(item.Title)}`
                );
                const tmdbData = await tmdbRes.json();
                if (tmdbData.results?.length) {
                    playVideo(`https://vidlink.pro/movie/${tmdbData.results[0].id}`);
                }
            } else {
                const tmdbRes = await fetch(
                    `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(item.Title)}`
                );
                const tmdbData = await tmdbRes.json();
                if (tmdbData.results?.length) {
                    const tvId = tmdbData.results[0].id;
                    const detailsRes = await fetch(
                        `https://api.themoviedb.org/3/tv/${tvId}?api_key=${TMDB_API_KEY}`
                    );
                    const details = await detailsRes.json();
                    showSeasons(tvId, details.seasons);
                }
            }
        });

        resultsDiv.appendChild(card);
    });
}

/* ===== VIDEO PLAYBACK ===== */
let currentEpisode = null;

function playVideo(url, episodeData = null) {
    const vc = document.getElementById("video-container");
    vc.innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
    vc.style.display = "block";
    document.body.classList.add("video-playing");

    history.pushState({ type: "player" }, "");

    const nextBtn = document.getElementById("next-episode-btn");

    if (episodeData) {
        currentEpisode = episodeData;
        nextBtn.style.display = "block";
    } else {
        currentEpisode = null;
        nextBtn.style.display = "none";
    }
}

/* ===== NEXT EPISODE BUTTON ===== */
document.getElementById("next-episode-btn").addEventListener("click", async () => {
    if (!currentEpisode) return;
    const { tvId, season, episode } = currentEpisode;

    const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}?api_key=${TMDB_API_KEY}`);
    const data = await res.json();

    let nextEpisodeNumber = episode + 1;
    let nextSeason = season;

    if (nextEpisodeNumber > data.episodes.length) {
        const tvRes = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${TMDB_API_KEY}`);
        const tvData = await tvRes.json();
        const currentSeasonIndex = tvData.seasons.findIndex(s => s.season_number === season);
        if (currentSeasonIndex + 1 < tvData.seasons.length) {
            nextSeason = tvData.seasons[currentSeasonIndex + 1].season_number;
            nextEpisodeNumber = 1;
        } else {
            alert("You've reached the end!");
            return;
        }
    }

    setCookie("continueWatching", JSON.stringify({
        tvId,
        season: nextSeason,
        episode: nextEpisodeNumber,
        title: `Episode ${nextEpisodeNumber}`
    }));

    playVideo(`https://vidlink.pro/tv/${tvId}/${nextSeason}/${nextEpisodeNumber}`, {
        tvId,
        season: nextSeason,
        episode: nextEpisodeNumber
    });
});

/* ===== SEASONS & EPISODES ===== */
function showSeasons(tvId, seasons) {
    const vc = document.getElementById("video-container");
    vc.innerHTML = "<h2>Select Season</h2>";

    seasons.forEach(s => {
        if (s.season_number === 0) return;
        const btn = document.createElement("button");
        btn.textContent = `Season ${s.season_number}`;
        btn.onclick = () => showEpisodes(tvId, s.season_number);
        vc.appendChild(btn);
    });

    vc.style.display = "block";
    document.body.classList.add("video-playing");
    history.pushState({ type: "view" }, "");
}

async function showEpisodes(tvId, seasonNumber) {
    const res = await fetch(
        `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${TMDB_API_KEY}`
    );
    const data = await res.json();

    const vc = document.getElementById("video-container");
    vc.innerHTML = `<h2>Season ${seasonNumber}</h2>`;

    data.episodes.forEach(ep => {
        const btn = document.createElement("button");
        btn.textContent = `Episode ${ep.episode_number}: ${ep.name}`;

        btn.addEventListener("click", () => {
            const episodeData = {
                tvId,
                season: seasonNumber,
                episode: ep.episode_number,
                title: ep.name
            };

            setCookie("continueWatching", JSON.stringify(episodeData));
            playVideo(`https://vidlink.pro/tv/${tvId}/${seasonNumber}/${ep.episode_number}`, episodeData);
        });

        vc.appendChild(btn);
    });

    vc.style.display = "block";
    document.body.classList.add("video-playing");
    history.pushState({ type: "view" }, "");
}

/* ===== INITIALIZE ===== */
loadContinueWatching();
</script>
</body>
</html>
